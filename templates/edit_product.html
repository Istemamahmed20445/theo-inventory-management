{% extends "base.html" %}

{% block title %}Edit Product - THEO CLOTHING INVENTORY{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-edit me-2"></i>Edit Product
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Product Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category *</label>
                                <div class="input-group">
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">Select Category</option>
                                        {% for category in categories %}
                                        <option value="{{ category.name }}" data-category-id="{{ category.id }}" data-category-description="{{ category.description or '' }}" {% if product.category == category.name %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Add New Category">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" id="editCategoryBtn" onclick="editSelectedCategory()" title="Edit Selected Category" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" id="deleteCategoryBtn" onclick="deleteSelectedCategory()" title="Delete Selected Category" disabled>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="size" class="form-label">Size</label>
                                <select class="form-select" id="size" name="size">
                                    <option value="">Select Size</option>
                                    <option value="XS" {% if product.size == 'XS' %}selected{% endif %}>XS</option>
                                    <option value="S" {% if product.size == 'S' %}selected{% endif %}>S</option>
                                    <option value="M" {% if product.size == 'M' %}selected{% endif %}>M</option>
                                    <option value="L" {% if product.size == 'L' %}selected{% endif %}>L</option>
                                    <option value="XL" {% if product.size == 'XL' %}selected{% endif %}>XL</option>
                                    <option value="XXL" {% if product.size == 'XXL' %}selected{% endif %}>XXL</option>
                                    <option value="28" {% if product.size == '28' %}selected{% endif %}>28</option>
                                    <option value="30" {% if product.size == '30' %}selected{% endif %}>30</option>
                                    <option value="32" {% if product.size == '32' %}selected{% endif %}>32</option>
                                    <option value="34" {% if product.size == '34' %}selected{% endif %}>34</option>
                                    <option value="36" {% if product.size == '36' %}selected{% endif %}>36</option>
                                    <option value="38" {% if product.size == '38' %}selected{% endif %}>38</option>
                                    <option value="40" {% if product.size == '40' %}selected{% endif %}>40</option>
                                    <option value="42" {% if product.size == '42' %}selected{% endif %}>42</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="color" class="form-label">Color *</label>
                                <input type="text" class="form-control" id="color" name="color" value="{{ product.color }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="price" class="form-label">Price (à§³) *</label>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="{{ product.price }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="body_size" class="form-label">Body Size</label>
                                <input type="text" class="form-control" id="body_size" name="body_size" value="{{ product.body_size or '' }}" placeholder="e.g., 36, 38, 40">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="waist_size" class="form-label">Waist Size</label>
                                <input type="text" class="form-control" id="waist_size" name="waist_size" value="{{ product.waist_size or '' }}" placeholder="e.g., 30, 32, 34">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="length" class="form-label">Length</label>
                                <input type="text" class="form-control" id="length" name="length" value="{{ product.length or '' }}" placeholder="e.g., 28, 30, 32">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ product.description }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="image" class="form-label">Product Image</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                        <div class="form-text">Leave empty to keep current image. Supported formats: JPG, PNG, GIF. Max size: 5MB</div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('products') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Products
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Update Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Current Image</h5>
            </div>
            <div class="card-body text-center">
                {% if product.image_url %}
                <img src="{{ product.image_url }}" class="img-fluid rounded mb-3" alt="Current Image">
                {% else %}
                <div class="mb-3">
                    <i class="fas fa-image fa-3x text-muted"></i>
                    <p class="text-muted mt-2">No image</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Product Details</h5>
            </div>
            <div class="card-body">
                <p><strong>Barcode:</strong> {{ product.barcode }}</p>
                <p><strong>Created:</strong> {{ product.created_at.strftime('%Y-%m-%d %H:%M') if product.created_at else 'N/A' }}</p>
                <p><strong>Last Updated:</strong> {{ product.updated_at.strftime('%Y-%m-%d %H:%M') if product.updated_at else 'N/A' }}</p>
                
                {% if product.qr_code_url %}
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="showBarcode('{{ product.barcode }}', '{{ product.qr_code_url }}')">
                        <i class="fas fa-barcode me-1"></i>View Barcode
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Barcode Modal -->
<div class="modal fade" id="barcodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Barcode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p><strong>Barcode:</strong> <span id="barcodeText"></span></p>
                <div id="barcodeImage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showBarcode(barcode, qrCodeUrl) {
    document.getElementById('barcodeText').textContent = barcode;
    document.getElementById('barcodeImage').innerHTML = '<img src="' + qrCodeUrl + '" class="img-fluid" alt="QR Code">';
    new bootstrap.Modal(document.getElementById('barcodeModal')).show();
}

// Image preview functionality
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.querySelector('.card-body img');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            if (preview) {
                preview.src = e.target.result;
            } else {
                const cardBody = document.querySelector('.card-body');
                cardBody.innerHTML = '<img src="' + e.target.result + '" class="img-fluid rounded mb-3" alt="Preview">';
            }
        };
        reader.readAsDataURL(file);
    }
});

// Category dropdown change handler
document.getElementById('category').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const editBtn = document.getElementById('editCategoryBtn');
    const deleteBtn = document.getElementById('deleteCategoryBtn');
    
    if (selectedOption.value && selectedOption.dataset.categoryId) {
        editBtn.disabled = false;
        deleteBtn.disabled = false;
    } else {
        editBtn.disabled = true;
        deleteBtn.disabled = true;
    }
});

// Initialize button states on page load
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    const editBtn = document.getElementById('editCategoryBtn');
    const deleteBtn = document.getElementById('deleteCategoryBtn');
    
    if (selectedOption.value && selectedOption.dataset.categoryId) {
        editBtn.disabled = false;
        deleteBtn.disabled = false;
    }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const requiredFields = ['name', 'category', 'color', 'price'];
    let isValid = true;
    
    requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields.');
    }
});

// Add Category Modal
function addCategory() {
    const categoryName = document.getElementById('newCategoryName').value;
    const categoryDescription = document.getElementById('newCategoryDescription').value;
    
    if (!categoryName) {
        alert('Please enter a category name');
        return;
    }
    
    // Show loading state
    const addBtn = document.querySelector('#addCategoryModal .btn-primary');
    const originalText = addBtn.textContent;
    addBtn.textContent = 'Adding...';
    addBtn.disabled = true;
    
    // Create form data
    const formData = new FormData();
    formData.append('name', categoryName);
    formData.append('description', categoryDescription);
    
    // Send AJAX request
    fetch('{{ url_for("add_category_ajax") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to dropdown
            const categorySelect = document.getElementById('category');
            const newOption = document.createElement('option');
            newOption.value = categoryName;
            newOption.textContent = categoryName;
            newOption.selected = true;
            categorySelect.appendChild(newOption);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryDescription').value = '';
            
            // Show success message
            alert('Category added successfully!');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding category. Please try again.');
    })
    .finally(() => {
        // Reset button state
        addBtn.textContent = originalText;
        addBtn.disabled = false;
    });
}

// Edit Selected Category
function editSelectedCategory() {
    const categorySelect = document.getElementById('category');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    
    if (!selectedOption.value || !selectedOption.dataset.categoryId) {
        alert('Please select a category to edit');
        return;
    }
    
    // Populate edit modal
    document.getElementById('editCategoryName').value = selectedOption.value;
    document.getElementById('editCategoryDescription').value = selectedOption.dataset.categoryDescription || '';
    document.getElementById('editCategoryId').value = selectedOption.dataset.categoryId;
    
    // Show edit modal
    const editModal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
    editModal.show();
}

// Update Category
function updateCategory() {
    const categoryId = document.getElementById('editCategoryId').value;
    const categoryName = document.getElementById('editCategoryName').value;
    const categoryDescription = document.getElementById('editCategoryDescription').value;
    
    if (!categoryName) {
        alert('Please enter a category name');
        return;
    }
    
    // Show loading state
    const updateBtn = document.querySelector('#editCategoryModal .btn-primary');
    const originalText = updateBtn.textContent;
    updateBtn.textContent = 'Updating...';
    updateBtn.disabled = true;
    
    // Create form data
    const formData = new FormData();
    formData.append('name', categoryName);
    formData.append('description', categoryDescription);
    
    // Send AJAX request
    fetch(`/edit_category_ajax/${categoryId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update dropdown option
            const categorySelect = document.getElementById('category');
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            selectedOption.value = categoryName;
            selectedOption.textContent = categoryName;
            selectedOption.dataset.categoryDescription = categoryDescription;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
            modal.hide();
            
            // Show success message
            alert('Category updated successfully!');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating category. Please try again.');
    })
    .finally(() => {
        // Reset button state
        updateBtn.textContent = originalText;
        updateBtn.disabled = false;
    });
}

// Delete Selected Category
function deleteSelectedCategory() {
    const categorySelect = document.getElementById('category');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    
    if (!selectedOption.value || !selectedOption.dataset.categoryId) {
        alert('Please select a category to delete');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete the category "${selectedOption.value}"?`)) {
        return;
    }
    
    // Show loading state
    const deleteBtn = document.getElementById('deleteCategoryBtn');
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Send AJAX request
    fetch(`/delete_category_ajax/${selectedOption.dataset.categoryId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove from dropdown
            selectedOption.remove();
            
            // Reset selection
            categorySelect.selectedIndex = 0;
            document.getElementById('editCategoryBtn').disabled = true;
            document.getElementById('deleteCategoryBtn').disabled = true;
            
            // Show success message
            alert('Category deleted successfully!');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting category. Please try again.');
    })
    .finally(() => {
        // Reset button state
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
    });
}
</script>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newCategoryName" class="form-label">Category Name *</label>
                    <input type="text" class="form-control" id="newCategoryName" required>
                </div>
                <div class="mb-3">
                    <label for="newCategoryDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="newCategoryDescription" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCategory()">Add Category</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCategoryId" value="">
                <div class="mb-3">
                    <label for="editCategoryName" class="form-label">Category Name *</label>
                    <input type="text" class="form-control" id="editCategoryName" required>
                </div>
                <div class="mb-3">
                    <label for="editCategoryDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="editCategoryDescription" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCategory()">Update Category</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
